- name: Install borg packages
  apt:
    pkg:
      - borgbackup

- name: Setup backup repository
  command: 'borg init --encryption=repokey /home/backup/'
  args:
    creates: /home/backup
  environment:
    BORG_PASSPHRASE: "{{ lookup('env', 'BORG_PASSPHRASE') }}"

- name: Copying backup script
  copy:
    src: backup.sh
    dest: /usr/local/bin/backup/  # TODO: install to /usr/local/bin
    mode: a+x

- name: Copying backup script systemd service file
  copy:
    src: backup.service
    dest: /etc/systemd/system/

- name: Copying backup script systemd timer file
  copy:
    src: backup.timer
    dest: /etc/systemd/system/

- name: Start backup script timer
  systemd:
    name: backup.timer
    enabled: true
    state: started
